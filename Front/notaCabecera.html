<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

    <link rel="shortcut icon" href="./Imagenes/M&E.ico">
    <title>M&E</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Sans:ital@1&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap');

        body {
            background-color: #b86262;
            font-family: 'Fira Sans', sans-serif;
        }

        .btn{
            background-color: #a30a0a;
            color: white;
            font-size: medium;
        }

        .btn:hover{
            color: white;
            border: 3px dashed #ffee32;
        }

        h1{
            font-family: 'Luckiest Guy', cursive;
        }

        .presentation, .tab-content{
            background-color: white;
            border-radius: 5px 5px 0 0;
        }

        a{
          color: black;
        }

        a:hover{
          color: rgb(82, 79, 79);
        }

        @media screen {
          #printSection {
              display: none;
          }
        }

        @media print {
          body * {
            visibility:hidden;
          }
          #printSection, #printSection * {
            visibility:visible;
          }
          #modal * {
            visibility:visible;
          }
          #printSection {
            position:absolute;
            left:0;
            top:0;
          }
        }
        .id{
          float: right;
          gap: 15px;
        }
    </style>
  </head>
  <body onload="OnLoad()" id="body">
    <!-- Navbar -->
    <section>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div style="display: flex; align-items: center; justify-content: center;">
                <img src="./Imagenes/m&elogo-modified.ico" alt="" style="height: 50px;">
                <h4 style="color: white; margin-top: 5%;">&nbsp M&E</h4>
            </div>
            
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button> 
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav mr-auto"></ul>
              <form class="form-inline my-2 my-lg-0" style="gap: 15px;">
                <a class="btn btn-success my-2 my-sm-0" href="menu.html">Volver</a>
                <a class="btn btn-success my-2 my-sm-0" type="button" href="notaDetalle.html">Detalle</a>
                <a class="btn btn-success my-2 my-sm-0" type="button" href="index.html">Salir<i class="bi bi-box-arrow-right"></i>
                </a>
              </form>
            </div>
          </nav>
    </section>
    <!-- HEAD -->
    <section class="container" style="text-align: center; margin-top: 2%;">
        <h1 class="display-3">NOTA PEDIDOS CABECERA</h1>
    </section>
    <!-- BODY -->
    <section class="container body">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item presentation" role="presentation">
              <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Listado de Pedidos cabecera</a>
            </li>

            <li class="nav-item presentation" role="presentation">
              <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Registrar Pedido Cabecera</a>
            </li>
            
          </ul>
          <div class="tab-content" id="myTabContent" style="margin-bottom: 3%;">
            <!-- Reportes -->
            <!-- Remitos -->
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="container" style="padding: 3%;">
                    <table class="table table-responsive-sm">
                      <table class="table table-responsive-md" id="TablaRemitos">
                        <thead class="thead-dark">
                            <th data-field="codigo">#</th>
                            <th data-field="estado">Fecha Emision</th>
                            <th data-field="fechaCompra">Fecha Entrega</th>
                            <th data-field="cliente">Empleado</th>
                            <th data-field="articulo">Estado</th>
                            <th>Acciones</th>
                        </thead>
                        <tbody id="cuerpoTabla"></tbody>
                        <tbody id="cuerpoTablaID"></tbody>
                        <tbody id="cuerpoTablaEstado"></tbody>
                        <tbody id="cuerpoTablaFecha"></tbody>
                        <tbody id="cuerpoTablaFE"></tbody>
                    </table>
                    <button id="btnDescargar" class="btn btn-default"> Descargar Excel </button>

                </div>
            </div>
          
          <!-- Cargar Remito -->
          <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
              <div class="container" style="padding: 3%;">
                <form class="needs-validation" novalidate id="carga">
                    <div class="form-row">
                      <div class="col-md-6 mb-3">
                        <label for="fecha">Fecha de Emision</label>
                        <input type="date" class="form-control" id="fecha" required>
                        <div class="invalid-feedback">
                          Ingrese una fecha de compra
                        </div>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="fechaA">Fecha de Entrega</label>
                        <input type="date" class="form-control" id="fechaA" required>
                        <div class="invalid-feedback">
                          Ingrese una fecha de entrega
                        </div>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="col-md-6 mb-3">
                        <label for="cliente">Empleado</label>
                        <select class="custom-select" id="cliente" required>
                            <option value="">Seleccionar...</option>
                          </select>
                        <div class="invalid-feedback">
                          Seleccione un empleado
                        </div>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="flag"> Estado </label>
                        <input type="number" class="custom-select" id="flag"
                            placeholder="0: Inactivo - 1: Activo">
                            <div class="invalid-feedback">
                                Seleccione un estado
                            </div>
                    </div>
                    </div>

                    <button class="btn" type="button" onclick="go()" id="btnCargar">Cargar Cabecera</button>
                  </form>
              </div>
          </div>
        </div>
        <!-- Modificar -->

     <div class="modal fade" id="update" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel"
     aria-hidden="true">
     <div class="modal-dialog">
         <div class="modal-content">
             <div class="modal-header">
                 <h5 class="modal-title">MODIFICAR CABECERA</h5>
                 <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                     <span aria-hidden="true">&times;</span>
                 </button>
             </div>
             <div class="modal-body">
                 <div class="container d-flex justify-content-center mt-5">
                     <section>
                         <form>
                             <div class="form-row">
                                 <div class="col-12 col-sm-12 sol-md-6 col-lg-6">
                                     <div class="form-group">
                                         <input type="hidden" class="form-control" id="txtId">
                                         <label> Fecha Emision </label>
                                         <input type="date" class="form-control" id="txtA">
                                     </div>
                                 </div>
                                 <div class="col-12 col-sm-12 sol-md-6 col-lg-6">
                                     <div class="form-group">
                                         <label> Fecha Entrega </label>
                                         <input type="date" class="form-control" id="txtB">
                                     </div>
                                 </div>
                             </div>
                             <div class="row">
                                 <div class="col-12 col-sm-12 sol-md-6 col-lg-6">
                                     <div class="form-group">
                                         <label> Empleado </label>
                                         <select  name="empleado" class="form-control mb-3" id="cboC">
                                        </select>
                                     </div>
                                 </div>
                                 <div class="col-12 col-sm-12 sol-md-6 col-lg-6">
                                     <div class="form-group">
                                         <label> Estado </label>
                                         <input type="number" class="form-control" id="txtD" disabled>
                                     </div>
                                 </div>
                             </div>
                 </div>
                 <div class="modal-footer">
                     <button type="button" class="btn btn-success" type="button" id="btnModificar">Aceptar</button>
                     <button type="button" class="btn" data-dismiss="modal">Cerrar</button>
                 </div>
             </div>
         </div>
     </div>
 </div>
 
     <!--BAJA PROVEEDOR-->
     <div class="modal fade" id="baja" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel"
         aria-hidden="true">
         <div class="modal-dialog">
             <div class="modal-content">
                 <div class="modal-header">
                     <h5 class="modal-title">BAJA CABECERA</h5>
                     <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                         <span aria-hidden="true">&times;</span>
                     </button>
                 </div>
                 <div class="modal-body">
                     <div class="container">                          
                                     <div class="col-12 col-sm-12 sol-md-6 col-lg-6">
                                         <div class="form-group">
                                             <input type="hidden" class="form-control" id="txtIdD"
                                             placeholder="Ingrese Id">
                                             <label> Estado </label>
                                             <input type="number" class="form-control" id="txtE"
                                                 placeholder="Ingrese Estado">
                                         </div>
                                     </div>                         
                     </div>
                     <div class="modal-footer">
                         <button type="button" class="btn btn-success" type="button" id="btnDelete">Aceptar</button>
                         <button type="button" class="btn" data-dismiss="modal">Cerrar</button>
                     </div>
                 </div>
             </div>
         </div>
     </div>
      </section>
     
 



      <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
      <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
      crossorigin="anonymous"></script>
      <script src="JS/tableToExcel.js"></script>
      <script src="JS/app.js"></script>


  </body>

  <script type="text/javascript">

fecha.min = new Date().toLocaleDateString('en-ca') //para la fecha
fechaA.min = new Date().toLocaleDateString('en-ca') //para la fecha


$('#btnDescargar').on('click', requestDescargar);

function requestDescargar(){
  tableToExcel('TablaRemitos', 'Datos', 'PedidoCabecera');
}
       
   let Clientes = [];
   let cont=[];

   // Validar Form
    function go() {
        var forms = document.getElementsByClassName('needs-validation');

        var validation = Array.prototype.filter.call(forms, function(form) {
        form.addEventListener('submit', function(event) {
            if (form.checkValidity() === false) {
            event.preventDefault();
            event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
        });
    }

    function OnLoad() {     
        // Tooltip
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })

   // Obtener Usuarios
   $(document).ready(function () {
    $.ajax({
        url: "https://localhost:5001/Usuario/ObtenerUsuario",
        type: "GET",
        success: function (result) {
            if (result.ok) {
                rol = result.return;
                cargarComboA(rol);
            } else {
                swal(result.error);
            }
        },
        error: function (error) {
            swal("Problemas al conseguir empleados");
        },
    })

    // carga combo
        function cargarComboA(datos) {

       // $("#cliente").append(html);
        select = document.getElementById("cliente");
        for (let i = 0; i < datos.length; i++) {
            var option = document.createElement('option');
            option.value = datos[i].legajo;
            option.text = datos[i].nombreCompleto;
            select.add(option);
        }
    }

})
}
//-----------------------------------------------------------------------------------------------------------------------------------------
 // Cargar Nota pedido

 $("#btnCargar").click(function () {
        let fecha = $("#fecha").val();
        let fechaA = $("#fechaA").val();//documento
        let empleado = $("#cliente").val();//direccion
        let flag = $("#flag").val();//flag


        if (fecha === "" || fechaA === "" || empleado === "" || flag === ""){
            swal("Ingrese los datos requeridos");
        } else {
            altaCabecera(fecha, fechaA, empleado, flag);
        }
    });

 function altaCabecera(fecha,fechaA,idEmpleado,flag) {
    comando = {
        "fechaEmision": fecha,
        "fechaEntrega": fechaA,
        "idEmpleado": idEmpleado,
        "flag":flag
    }

    $.ajax({
        url: "https://localhost:5001/NotaPedido/AltaOrdenCompra",
        dataType:'json',
        contentType:'application/json',
        data: JSON.stringify(comando),
        type: "POST",
        success: function(result) {
            if (result.ok){
                swal("Alta exitosa! Cargue Detalle!");
                setTimeout(function () { location.replace("http://127.0.0.1:5503/Front/notaCabecera.html"); }, 3000);
            }
            else swal(result.error);
        },
        error: function(error) {
            swal(error);
        }
    });
}

//----------------------------------------------------------------------------------------------------------------------------------------------------
  //obtener notas pedidos cargar listado
  $(document).ready(function () {
        $.ajax({
            url: "https://localhost:5001/NotaPedido/ObtenerOrdenCompra",
            type: "GET",
            success: function (result) {
                if (result.ok) {
                    console.log(result)
                    cargarTabla(result.return);
                } else {
                    alert(result.error)
                }
            },
            error: function (error) {
                swal("Problemas al conseguir Ordenes de Pedido");
            },
        })
    })


    //cargar en tabla las nota de pedido
    function cargarTabla(datos) {
        for (let i = 0; i < datos.length; i++) {
            let html = "<tr id='lista'>";
            html += "<td>" + datos[i].idOrdenCompra + "</td>";
            html += "<td>" + roundDate(datos[i].fechaEmision) + "</td>";
            html += "<td>" + roundDate(datos[i].fechaEntrega) + "</td>";
            html += "<td>" + datos[i].idEmpleadoNavigation.nombreCompleto+ "</td>";

            if (datos[i].flag == 0) {
                html += "<td style=color:red;>inactivo</td>";//hacer que se muestre rojo: INACTIVO
            }
            else if (datos[i].flag == 1) {
                html += "<td style=color:#6bb83e;>activo</td>";//hacer que se muestre verde: ACTIVO
            }

            Clientes.push(datos[i]);
            //cont.push(0);

            html += "</td>";  
            html += "<td><button type='button' class='btn btn-primary pl-4 pr-4'' id='modificar' onclick='modificar (" + datos[i].idOrdenCompra + ")' data-toggle='modal' data-target='#update' data-placement='bottom'>" +
                "<i class='bi bi-pencil-fill'></i></button> &nbsp;" +
                "<button type='button' id='btnBaja' name='btnBaja' class='btn btn-success pl-4 pr-4' onclick='eliminar (" + datos[i].idOrdenCompra + ") ' data-toggle='modal' data-target='#baja' data-placement='bottom'>" +
                "<i class='bi bi-trash-fill'></i></button> " + "</td>";
            html += "</tr>"
            $("#cuerpoTabla").append(html);
        }
       // $('#txtA').html(datos[0].nombreCliente);

    }
    //para que la fecha no salga hora, etc
    function roundDate(timeStamp) {
        var yyyy = new Date(timeStamp).getFullYear().toString();
        var mm = new Date(timeStamp).getMonth() + 1;
        var dd = new Date(timeStamp).getDate().toString();
        return dd + "/" + mm + "/" + yyyy;
    }


 //------------------------------------------------------------------------------------------------------------------------------------
 //modificar
    //get tipo articulo
    $(document).ready(function () {
        $.ajax({
            url: "https://localhost:5001/Usuario/ObtenerUsuario",
            type: "GET",
            success: function (result) {
                if (result.ok) {
                    rol = result.return;
                    cargarCombo(rol);
                } else {
                    swal(result.error);
                }
            },
            error: function (error) {
                swal("Problemas al conseguir datos de tipo articulos");
            },
        })

        // carga combo
        function cargarCombo(datos) {
            var html = "<option value=''> SELECCIONE </option>";
            $("#cboC").append(html);
            select = document.getElementById("cboC");
            for (let i = 0; i < datos.length; i++) {
                var option = document.createElement('option');
                option.value = datos[i].legajo;
                option.text = datos[i].nombreCompleto;
                select.add(option);
            }
        }

    })

//llenar modal y pasar campos para modificar
function modificar(id) {
        let idOrdenCompra= id;
        let fechaEm = 0;
        let fechaEn = 0;
        let emple = 0;
        let flag = 0;

        for (let i = 0; i < Clientes.length; i++) {
            if (Clientes[i].idOrdenCompra == id) {
                fechaEm = Clientes[i].fechaEmision;
                fechaEn = Clientes[i].fechaEntrega;
                emple = Clientes[i].idEmpleado;
                flag = Clientes[i].flag;


            }
        }
        $("#txtId").val(idOrdenCompra);
        document.getElementById('txtA').valueAsDate = new Date();
        document.getElementById('txtB').valueAsDate = new Date();
       // $("#txtA").val(fechaEm);
       // $("#txB").val(fechaEn);
        $("#cboC").val(emple);
        $("#txtD").val(flag);



        $("#btnModificar").click(function () {
            let idOrdenCompra= $("#txtId").val();
            let fechaEmision = $("#txtA").val();
            let fechaEntrega = $("#txtB").val();
            let idEmpleado = $("#cboC").val();
            let bandera = $("#txtD").val();


            if (fechaEmision === "" || fechaEntrega === "" || idEmpleado === "" || bandera === "") {
                swal("Ingrese los datos requeridos");
            }
            else
                modificarProveedor(idOrdenCompra, fechaEmision, fechaEntrega, idEmpleado, bandera);
        })
    }
    //modificar cabecera
    function modificarProveedor(idOrdenCompra, fechaEmision, fechaEntrega, idEmpleado, bandera) {
        comando = {
            "idOrdenCompra": parseInt(idOrdenCompra),
            "fechaEmision": fechaEmision,
            "fechaEntrega": fechaEntrega,
            "idEmpleado": idEmpleado,
            "flag": parseInt(bandera),
        }

        $.ajax({
            url: "https://localhost:5001/NotaPedido/UpdateOrdenCompra",
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify(comando),
            type: "PUT",
            success: function (result) {
                if (result.ok) {
                    swal("Cabecera modificado exitosamente! Modifique Detalle de Requerirlo!");
                    setTimeout(function () { location.replace("http://127.0.0.1:5503/Front/notaCabecera.html"); }, 3000);

                }
                else swal(result.error);
            },
            error: function (error) {
                swal("Error" + error);
            }
        });
    }
//eliminar cabecera
    function eliminar(id) {
        let idOrdenCompra = id;
        let bandera = 0;

        for (let i = 0; i <Clientes.length; i++) {
            if (Clientes[i].idOrdenCompra == id) {
                bandera = Clientes[i].flag;
            }
        }

        $("#txtIdD").val(idOrdenCompra);
        $("#txtE").val(bandera);


    $("#btnDelete").click(function () {
        let idOrdenCompra = $("#txtIdD").val();
        let bandera = $("#txtE").val();

        if (idOrdenCompra ==="" || bandera === "") {
            swal("Ingrese los datos requeridos");
        } else {
            eliminarProveedor(idOrdenCompra, bandera);
        }
    })
}

    function eliminarProveedor(idOrdenCompra, bandera) {
        comando = {
            "idOrdenCompra": parseInt(idOrdenCompra),
            "flag": parseInt(bandera),
        }

        $.ajax({
            url: "https://localhost:5001/NotaPedido/ActualizarFlagNotaPedido/" + idOrdenCompra,
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify(comando),
            type: "PUT",
            success: function (result) {
                if (result.ok) {
                    swal("Cabecera dado de baja exitosamente");
                    setTimeout(function () { location.replace("http://127.0.0.1:5503/Front/notaCabecera.html"); }, 3000);

                }
                else swal(result.error);
            },
            error: function (error) {
                swal("Error" + error);
            }
        });
    }

  </script>
</html>